# 管理后台分页列表“导出全部”实现规范

## 目标

- 为任意管理后台分页列表提供“导出全部数据”功能。
- 导出的列标题、顺序、字典翻译需与前端当前列表展示完全一致。
- 导出数据严格复用列表查询逻辑（含数据权限、筛选、排序），仅调整分页策略，不允许复制粘贴逻辑。
- 前端调用体验与现有 JeecgListMixin 保持一致，用户筛选后可直接导出对应结果。

## 名词说明

| 名称 | 说明 |
| --- | --- |
| 列表查询接口 | 现有 `GET /xx/list` 控制器方法，通常返回分页数据 `IPage<T>` |
| 导出接口 | 新增 `GET /xx/exportAll` 控制器方法，返回 Excel 下载 |
| Map 导出视图 | `JeecgMapExcelView`，支持自定义 `ExcelExportEntity` 列头 |
| 字典翻译 | 通过 `ISysDictService#queryDictTextByKey` 将枚举值转中文 |

## 后端规范

### 1. 控制器命名与签名

- 路径：`/xx/xx/exportAll`
- 方法签名示例：
  ```java
  @AutoLog(value = "xxx-导出")
  @ApiOperation(value = "xxx-导出", notes = "xxx-导出")
  @GetMapping(value = "/exportAll")
  public ModelAndView exportAll(XxxQueryDTO queryDTO, HttpServletRequest request)
  ```
- 可重用查询 DTO/VO，与列表接口签名保持一致。

### 2. 复用分页查询

1. 构造分页：
   ```java
   Page<Entity> countPage = new Page<>(1, 1, true);
   IPage<VO> firstPage = service.queryPageList(countPage, queryDTO);
   long total = firstPage.getTotal();
   ```
2. 当 `total > 0`，构造 `Page<Entity> dataPage = new Page<>(1, total, false); dataPage.setSize(total);`；
   调用同一 `queryPageList(dataPage, queryDTO)` 获取全部记录。
3. 如收到 `ids`（或 `selections`）参数，**必须优先在 SQL 查询条件中追加 `IN` 过滤**；
   - DTO/VO 建议新增 `List<String> ids` 临时字段，Mapper XML 中 `<foreach>` 生成 `IN` 条件。
   - 仅当既有 Mapper 难以扩展时，才在内存中二次过滤作为兜底。
4. 为保持导出顺序与勾选一致，可在查询后按照 `ids` 构建的 `orderMap` 进行 `sorted` 重排。
5. 禁止新建额外 Mapper/SQL；所有过滤、权限判断需复用原服务方法或在现有 SQL 上扩展条件。

### 3. 构建导出列

1. 声明 `List<ExcelExportEntity> entityList`，顺序与前端列配置一致。
2. 模型字段 ➜ 导出行：
   ```java
   List<Map<String, Object>> dataList = records.stream().map(item -> {
       Map<String, Object> row = new HashMap<>();
       row.put("index", counter.getAndIncrement());
       row.put("orderNo", item.getOrderNo());
       row.put("payType", dictService.queryDictTextByKey("member_deal_type", item.getPayType()));
       // ...
       return row;
   }).collect(Collectors.toList());
   ```
3. 字典/状态字段必须进行文本转换；缺省值保留原值。
4. 日期统一使用 `DateUtil.formatDateTime` (`yyyy-MM-dd HH:mm:ss`)；为空返回空字符串。

### 4. 构造导出视图

```java
ModelAndView mv = new ModelAndView(new JeecgMapExcelView());
mv.addObject(MapExcelConstants.FILE_NAME, "文件名");
mv.addObject(MapExcelConstants.ENTITY_LIST, entityList);
mv.addObject(MapExcelConstants.MAP_LIST, dataList);
mv.addObject(MapExcelConstants.PARAMS,
    new ExportParams("报表标题", "导出人:" + (user != null ? user.getRealname() : ""), "导出信息"));
return mv;
```

### 5. 权限 / 角色处理

- 与列表查询一致：若列表会根据登录身份注入 `sysUserId` 等条件，导出接口需在调用 `queryPageList` 前补充相同逻辑。
- 可直接调用工具类（如 `PermissionUtils`）或按订单导出示例，使用角色判断限制数据范围。

## 前端规范

### 1. URL 配置

```js
data() {
  return {
    url: {
      list: '/xxx/list',
      exportAllUrl: 'xxx/exportAll',
    }
  }
}
```

### 2. 导出方法

```js
handleExportXls(fileName) {
  if (!fileName || typeof fileName !== 'string') {
    fileName = '导出文件'
  }
  const param = this.getQueryParams()
  delete param.pageNo
  delete param.pageSize
  delete param.field
  if (this.selectedRowKeys && this.selectedRowKeys.length > 0) {
    param.ids = this.selectedRowKeys.join(',')
  }
  this.exportLoading = true
  downFile(this.url.exportAllUrl, param)
    .then(data => downloadBlob(data, fileName))
    .finally(() => { this.exportLoading = false })
}
```

- 勿再传 `paramsStr`、`pageNo/pageSize`、`field`；后端已处理全部。
- 若需要“导出选中”，可在 `param` 中补充 `ids = selectedRowKeys.join(',')`，后端自行兼容。

### 3. 列表列同步

- 导出列顺序需与 `columns` 数组保持一致。
- 若前端存在 `scopedSlots` 渲染逻辑，后端导出时需同步处理（例如收入/支出、状态标签）。
- 建议在 PR 中列出列标题，方便 reviewer 核对。

## 测试清单

- [ ] 带筛选条件导出，核对行数、字段值、字典文本与页面一致。
- [ ] 不带筛选导出，确认包含所有数据。
- [ ] 不同角色（平台、商家、代理）导出，只能看到各自数据。
- [ ] 列表新增列后，导出列同步更新。
- [ ] 大量数据（>1w）导出验证性能，必要时采用流式分批写入。

## 常见问题与处理

| 问题 | 原因 | 解决方案 |
| --- | --- | --- |
| 列顺序不符 | 后端导出列未与前端同步 | 以页面 `columns` 为准重新对齐 |
| 过滤条件失效 | 导出接口重新拼查询条件、未复用服务 | 必须调用原 `queryPageList` / Mapper 方法 |
| 数据缺失 | 未考虑登录人角色过滤 | 复用列表获取的权限逻辑（PermissionUtils 或角色判断） |
| Excel 文本是原值 | 未做字典翻译 | 使用 `ISysDictService#queryDictTextByKey` 或自定义映射 |
| 勾选导出无效 | 前端未传递 `ids` 或后端未按 `ids` 过滤 | 前端拼接 `param.ids`，后端接收后按顺序过滤 |